<div class="min-h-screen flex flex-col p-4 md:p-6 lg:p-8">
  <div class="w-full max-w-4xl mx-auto">
    @switch (viewState()) {
      <!-- Selection View -->
      @case ('selection') {
        <div class="text-center mb-8">
          <h1
            class="text-4xl md:text-5xl font-black mb-3 bg-gradient-to-r from-cyan-400 via-purple-400 to-pink-400 text-transparent bg-clip-text"
          >
            Local Lobby Setup
          </h1>
          <p class="text-neutral-400 text-lg">Connect devices locally via Bluetooth without internet</p>
        </div>

        <div class="space-y-6">
          <!-- Device Name Input -->
          <div class="bg-gray-800 rounded-xl p-6 border border-neutral-700">
            <label class="block text-neutral-300 mb-2 font-medium">Device Name</label>
            <input
              type="text"
              [(ngModel)]="deviceName"
              placeholder="Enter your device name"
              class="w-full bg-gray-900 text-neutral-100 rounded-lg px-4 py-3 border border-neutral-600 focus:border-cyan-500 focus:outline-none focus:ring-2 focus:ring-cyan-500/50"
            />
          </div>

          <!-- Host or Join -->
          <div class="grid md:grid-cols-2 gap-6">
            <!-- Create Host Lobby -->
            <div
              class="bg-gradient-to-br from-cyan-900/30 to-cyan-800/20 rounded-xl p-6 border border-cyan-700/50 hover:border-cyan-500 transition-all"
            >
              <div class="flex items-center gap-3 mb-4">
                <div
                  class="w-12 h-12 rounded-lg bg-gradient-to-br from-cyan-500 to-cyan-600 flex items-center justify-center"
                >
                  <svg class="w-7 h-7 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M5 12h14M12 5l7 7-7 7"
                    />
                  </svg>
                </div>
                <h2 class="text-2xl font-bold text-gray-50">Create Lobby</h2>
              </div>
              <p class="text-neutral-300 mb-6 leading-relaxed">
                Start a local lobby and let other devices discover and join via Bluetooth.
              </p>
              <button
                (click)="createHostLobby()"
                [disabled]="isConnecting() || !deviceName()"
                class="w-full bg-gradient-to-r from-cyan-500 to-cyan-600 hover:from-cyan-600 hover:to-cyan-700 disabled:from-gray-600 disabled:to-gray-700 disabled:cursor-not-allowed text-white font-semibold py-3 px-6 rounded-lg transition-all shadow-lg"
              >
                {{ isConnecting() ? 'Creating...' : 'Create Lobby' }}
              </button>
            </div>

            <!-- Join Lobby -->
            <div
              class="bg-gradient-to-br from-purple-900/30 to-purple-800/20 rounded-xl p-6 border border-purple-700/50 hover:border-purple-500 transition-all"
            >
              <div class="flex items-center gap-3 mb-4">
                <div
                  class="w-12 h-12 rounded-lg bg-gradient-to-br from-purple-500 to-purple-600 flex items-center justify-center"
                >
                  <svg class="w-7 h-7 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M12 4v16m8-8H4"
                    />
                  </svg>
                </div>
                <h2 class="text-2xl font-bold text-gray-50">Join Lobby</h2>
              </div>
              <p class="text-neutral-300 mb-4 leading-relaxed">
                Enter the lobby ID to discover and connect to the host device.
              </p>
              <input
                type="text"
                [(ngModel)]="lobbyIdInput"
                placeholder="Lobby ID"
                class="w-full bg-gray-900 text-neutral-100 rounded-lg px-4 py-3 mb-4 border border-neutral-600 focus:border-purple-500 focus:outline-none focus:ring-2 focus:ring-purple-500/50"
              />
              <button
                (click)="joinClientLobby()"
                [disabled]="isConnecting() || !deviceName() || !lobbyIdInput()"
                class="w-full bg-gradient-to-r from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 disabled:from-gray-600 disabled:to-gray-700 disabled:cursor-not-allowed text-white font-semibold py-3 px-6 rounded-lg transition-all shadow-lg"
              >
                {{ isConnecting() ? 'Connecting...' : 'Join Lobby' }}
              </button>
            </div>
          </div>

          <!-- Error Message -->
          @if (error()) {
            <div class="bg-red-900/30 border border-red-700/50 rounded-lg p-4">
              <p class="text-red-300">{{ error() }}</p>
            </div>
          }
        </div>
      }

      <!-- Host View -->
      @case ('host') {
        <div class="text-center mb-8">
          <h1
            class="text-3xl md:text-4xl font-black mb-2 bg-gradient-to-r from-cyan-400 to-cyan-500 text-transparent bg-clip-text"
          >
            Lobby Host
          </h1>
          <p class="text-neutral-400 text-lg">Lobby ID: <span class="text-cyan-400 font-mono">{{ lobbyId() }}</span></p>
        </div>

        <div class="space-y-6">
          <!-- Lobby Status -->
          <div class="bg-gray-800 rounded-xl p-6 border border-neutral-700">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-xl font-bold text-gray-50">Connected Devices</h3>
              <span class="text-2xl font-bold text-cyan-400">{{ deviceCount() }}</span>
            </div>

            @if (devices().length === 0) {
              <div class="text-center py-8">
                <div class="animate-pulse mb-4">
                  <svg
                    class="w-16 h-16 text-neutral-600 mx-auto"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"
                    />
                  </svg>
                </div>
                <p class="text-neutral-400">Waiting for devices to connect...</p>
                <p class="text-neutral-500 text-sm mt-2">Share the Lobby ID with other devices</p>
              </div>
            } @else {
              <div class="space-y-3">
                @for (device of devices(); track device.id) {
                  <div class="bg-gray-900 rounded-lg p-4 border border-neutral-700">
                    <div class="flex items-center justify-between">
                      <div class="flex items-center gap-3">
                        <span class="text-2xl">{{ getConnectionStatusIcon(device) }}</span>
                        <div>
                          <p class="text-neutral-100 font-medium">{{ device.name }}</p>
                          <p class="text-neutral-500 text-sm">{{ getConnectionStatusText(device) }}</p>
                        </div>
                      </div>
                      @if (device.rtcReady) {
                        <span class="text-green-400 text-sm font-medium">WebRTC Ready</span>
                      } @else {
                        <span class="text-yellow-400 text-sm font-medium">Setting up...</span>
                      }
                    </div>
                  </div>
                }
              </div>
            }
          </div>

          <!-- Actions -->
          <div class="space-y-4">
            @if (!isSetupComplete()) {
              <!-- Establish WebRTC Connections -->
              @if (deviceCount() > 0) {
                <button
                  (click)="establishConnections()"
                  [disabled]="isConnecting()"
                  class="w-full bg-gradient-to-r from-cyan-500 to-cyan-600 hover:from-cyan-600 hover:to-cyan-700 disabled:from-gray-600 disabled:to-gray-700 disabled:cursor-not-allowed text-white font-semibold py-3 px-6 rounded-lg transition-all shadow-lg"
                >
                  {{ isConnecting() ? 'Establishing Connections...' : 'Establish WebRTC Connections' }}
                </button>
              }

              <!-- Complete Setup -->
              @if (allDevicesReady()) {
                <button
                  (click)="completeSetup()"
                  class="w-full bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-semibold py-4 px-6 rounded-lg transition-all shadow-lg text-lg"
                >
                  ✓ Complete Setup
                </button>
              }
            } @else {
              <div class="bg-green-900/30 border border-green-700/50 rounded-lg p-6 text-center">
                <div class="text-4xl mb-2">✓</div>
                <p class="text-green-300 font-semibold text-lg">Setup Complete!</p>
                <p class="text-neutral-400 mt-2">Return to the main menu to select a game mode.</p>
                <p class="text-neutral-400 text-sm">All connected devices will automatically join.</p>
              </div>
            }

            <!-- Back Button -->
            <button
              (click)="back()"
              class="w-full bg-gray-700 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition-all"
            >
              Back to Menu
            </button>
          </div>
        </div>
      }

      <!-- Client View -->
      @case ('client') {
        <div class="text-center mb-8">
          <h1
            class="text-3xl md:text-4xl font-black mb-2 bg-gradient-to-r from-purple-400 to-purple-500 text-transparent bg-clip-text"
          >
            Lobby Client
          </h1>
          <p class="text-neutral-400 text-lg">Connected to: <span class="text-purple-400 font-mono">{{ lobbyId() }}</span></p>
        </div>

        <div class="space-y-6">
          <!-- Connection Status -->
          <div class="bg-gray-800 rounded-xl p-8 border border-neutral-700 text-center">
            <div class="animate-pulse mb-4">
              <svg
                class="w-20 h-20 text-purple-400 mx-auto"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"
                />
              </svg>
            </div>
            <h3 class="text-2xl font-bold text-gray-50 mb-2">Connected to Host</h3>
            <p class="text-neutral-400 mb-4">Waiting for host to complete setup...</p>
            <div class="inline-flex items-center gap-2 bg-purple-900/30 border border-purple-700/50 rounded-lg px-4 py-2">
              <div class="w-2 h-2 bg-purple-400 rounded-full animate-pulse"></div>
              <span class="text-purple-300 text-sm font-medium">Standby Mode</span>
            </div>
          </div>

          <!-- Information -->
          <div class="bg-blue-900/20 border border-blue-700/50 rounded-lg p-6">
            <h4 class="text-blue-300 font-semibold mb-2">ℹ️ What happens next?</h4>
            <ul class="text-neutral-400 text-sm space-y-2">
              <li>• Host will establish WebRTC connections with all devices</li>
              <li>• Once setup is complete, host will select a game mode</li>
              <li>• Your device will automatically join the selected mode</li>
              <li>• Keep this screen open while waiting</li>
            </ul>
          </div>

          <!-- Back Button -->
          <button
            (click)="back()"
            class="w-full bg-gray-700 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition-all"
          >
            Back to Menu
          </button>
        </div>
      }
    }
  </div>
</div>
