<div class="min-h-screen flex flex-col p-4 md:p-6 lg:p-8">
  <div class="w-full max-w-4xl mx-auto">
    @switch (viewState()) {
      <!-- Selection View -->
      @case ('selection') {
        <div class="text-center mb-8">
          <h1
            class="text-4xl md:text-5xl font-black mb-3 bg-gradient-to-r from-emerald-400 via-teal-400 to-cyan-400 text-transparent bg-clip-text"
          >
            Advanced Lobby Setup
          </h1>
          <p class="text-neutral-400 text-lg">Production-ready WebRTC with trickle ICE & message queuing</p>
        </div>

        <div class="space-y-6">
          <!-- Device Name Input -->
          <div class="bg-gray-800 rounded-xl p-6 border border-neutral-700">
            <label class="block text-neutral-300 mb-2 font-medium">Device Name</label>
            <input
              type="text"
              [(ngModel)]="deviceName"
              placeholder="Enter your device name"
              class="w-full bg-gray-900 text-neutral-100 rounded-lg px-4 py-3 border border-neutral-600 focus:border-emerald-500 focus:outline-none focus:ring-2 focus:ring-emerald-500/50"
            />
          </div>

          <!-- Host or Join -->
          <div class="grid md:grid-cols-2 gap-6">
            <!-- Create Host Lobby -->
            <div
              class="bg-gradient-to-br from-emerald-900/30 to-emerald-800/20 rounded-xl p-6 border border-emerald-700/50 hover:border-emerald-500 transition-all"
            >
              <div class="flex items-center gap-3 mb-4">
                <div
                  class="w-12 h-12 rounded-lg bg-gradient-to-br from-emerald-500 to-emerald-600 flex items-center justify-center"
                >
                  <svg class="w-7 h-7 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M5 12h14M12 5l7 7-7 7"
                    />
                  </svg>
                </div>
                <h2 class="text-2xl font-bold text-gray-50">Create Lobby</h2>
              </div>
              <p class="text-neutral-300 mb-6 leading-relaxed">
                Start an advanced lobby with production-ready WebRTC features including trickle ICE and automatic connection recovery.
              </p>
              <button
                (click)="createHostLobby()"
                [disabled]="isConnecting() || !deviceName()"
                class="w-full bg-gradient-to-r from-emerald-500 to-emerald-600 hover:from-emerald-600 hover:to-emerald-700 disabled:from-gray-600 disabled:to-gray-700 disabled:cursor-not-allowed text-white font-semibold py-3 px-6 rounded-lg transition-all shadow-lg"
              >
                {{ isConnecting() ? 'Creating...' : 'Create Advanced Lobby' }}
              </button>
            </div>

            <!-- Join Lobby -->
            <div
              class="bg-gradient-to-br from-teal-900/30 to-teal-800/20 rounded-xl p-6 border border-teal-700/50 hover:border-teal-500 transition-all"
            >
              <div class="flex items-center gap-3 mb-4">
                <div
                  class="w-12 h-12 rounded-lg bg-gradient-to-br from-teal-500 to-teal-600 flex items-center justify-center"
                >
                  <svg class="w-7 h-7 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M12 4v16m8-8H4"
                    />
                  </svg>
                </div>
                <h2 class="text-2xl font-bold text-gray-50">Join Lobby</h2>
              </div>
              <p class="text-neutral-300 mb-6 leading-relaxed">
                Discover and join advanced lobbies with enhanced connection monitoring and automatic reconnection.
              </p>
              <button
                (click)="joinClientLobby()"
                [disabled]="isConnecting() || !deviceName()"
                class="w-full bg-gradient-to-r from-teal-500 to-teal-600 hover:from-teal-600 hover:to-teal-700 disabled:from-gray-600 disabled:to-gray-700 disabled:cursor-not-allowed text-white font-semibold py-3 px-6 rounded-lg transition-all shadow-lg"
              >
                {{ isConnecting() ? 'Scanning...' : 'Scan & Join' }}
              </button>
            </div>
          </div>

          <!-- Error Message -->
          @if (error()) {
            <div class="bg-red-900/30 border border-red-700/50 rounded-lg p-4">
              <p class="text-red-300">{{ error() }}</p>
            </div>
          }

          <!-- Features List -->
          <div class="bg-gray-800/50 rounded-lg p-6 border border-neutral-700/50">
            <h3 class="text-emerald-400 font-semibold mb-3">✨ Advanced Features</h3>
            <ul class="text-neutral-400 text-sm space-y-2">
              <li>• <strong>Trickle ICE:</strong> Incremental candidate exchange for faster connections</li>
              <li>• <strong>Message Queuing:</strong> Reliable delivery even during connection setup</li>
              <li>• <strong>Connection Monitoring:</strong> Real-time state tracking and recovery</li>
              <li>• <strong>Early Candidate Buffering:</strong> No candidates lost during negotiation</li>
            </ul>
          </div>
        </div>
      }

      <!-- Host View -->
      @case ('host') {
        <div class="text-center mb-8">
          <h1
            class="text-3xl md:text-4xl font-black mb-2 bg-gradient-to-r from-emerald-400 to-emerald-500 text-transparent bg-clip-text"
          >
            Advanced Lobby Host
          </h1>
          <p class="text-neutral-400 text-lg">Broadcasting advanced lobby via Bluetooth</p>
        </div>

        <div class="space-y-6">
          <!-- Lobby Status -->
          <div class="bg-gray-800 rounded-xl p-6 border border-neutral-700">
            <div class="flex items-center justify-between mb-4">
              <h3 class="text-xl font-bold text-gray-50">Connected Devices</h3>
              <span class="text-2xl font-bold text-emerald-400">{{ deviceCount() }}</span>
            </div>

            @if (devices().length === 0) {
              <div class="text-center py-8">
                <div class="animate-pulse mb-4">
                  <svg
                    class="w-16 h-16 text-neutral-600 mx-auto"
                    fill="none"
                    viewBox="0 0 24 24"
                    stroke="currentColor"
                  >
                    <path
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      stroke-width="2"
                      d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"
                    />
                  </svg>
                </div>
                <p class="text-neutral-400">Waiting for devices to connect...</p>
                <p class="text-neutral-500 text-sm mt-2">Other devices can scan and join via Bluetooth</p>
              </div>
            } @else {
              <div class="space-y-3">
                @for (device of devices(); track device.id) {
                  <div class="bg-gray-900 rounded-lg p-4 border border-neutral-700">
                    <div class="flex items-center justify-between mb-2">
                      <div class="flex items-center gap-3">
                        <span class="text-2xl">{{ getConnectionStatusIcon(device) }}</span>
                        <div>
                          <p class="text-neutral-100 font-medium">{{ device.name }}</p>
                          <p class="text-neutral-500 text-sm">{{ getConnectionStatusText(device) }}</p>
                        </div>
                      </div>
                    </div>
                    <!-- Enhanced Status Details -->
                    <div class="flex items-center gap-3 mt-3 text-xs">
                      <div
                        class="px-2 py-1 rounded"
                        [ngClass]="{
                          'bg-green-900/30 text-green-400': device.rtcState === 'connected',
                          'bg-yellow-900/30 text-yellow-400': device.rtcState === 'connecting' || device.rtcState === 'new',
                          'bg-red-900/30 text-red-400': device.rtcState === 'failed' || device.rtcState === 'closed',
                          'bg-gray-700 text-gray-400': device.rtcState === 'disconnected'
                        }"
                      >
                        RTC: {{ getRtcStateLabel(device.rtcState) }}
                      </div>
                      <div
                        class="px-2 py-1 rounded"
                        [ngClass]="{
                          'bg-green-900/30 text-green-400': device.dataChannelReady,
                          'bg-yellow-900/30 text-yellow-400': !device.dataChannelReady
                        }"
                      >
                        Channel: {{ device.dataChannelReady ? 'Open' : 'Pending' }}
                      </div>
                    </div>
                  </div>
                }
              </div>
            }
          </div>

          <!-- Actions -->
          <div class="space-y-4">
            @if (!isSetupComplete()) {
              <!-- Complete Setup (automatic WebRTC establishment) -->
              @if (allDevicesReady()) {
                <button
                  (click)="completeSetup()"
                  class="w-full bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-semibold py-4 px-6 rounded-lg transition-all shadow-lg text-lg"
                >
                  ✓ Complete Setup
                </button>
              } @else if (deviceCount() > 0) {
                <div class="bg-yellow-900/20 border border-yellow-700/50 rounded-lg p-4 text-center">
                  <div class="animate-spin inline-block w-6 h-6 border-2 border-yellow-400 border-t-transparent rounded-full mb-2"></div>
                  <p class="text-yellow-300 text-sm">Establishing WebRTC connections automatically...</p>
                </div>
              }
            } @else {
              <div class="bg-green-900/30 border border-green-700/50 rounded-lg p-6 text-center">
                <div class="text-4xl mb-2">✓</div>
                <p class="text-green-300 font-semibold text-lg">Setup Complete!</p>
                <p class="text-neutral-400 mt-2">Return to the main menu to select a game mode.</p>
                <p class="text-neutral-400 text-sm">All connected devices will automatically join.</p>
              </div>
            }

            <!-- Back Button -->
            <button
              (click)="back()"
              class="w-full bg-gray-700 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition-all"
            >
              Back to Menu
            </button>
          </div>
        </div>
      }

      <!-- Client View -->
      @case ('client') {
        <div class="text-center mb-8">
          <h1
            class="text-3xl md:text-4xl font-black mb-2 bg-gradient-to-r from-teal-400 to-teal-500 text-transparent bg-clip-text"
          >
            Advanced Lobby Client
          </h1>
          <p class="text-neutral-400 text-lg">Connected to advanced host</p>
        </div>

        <div class="space-y-6">
          <!-- Connection Status -->
          <div class="bg-gray-800 rounded-xl p-8 border border-neutral-700 text-center">
            <div class="animate-pulse mb-4">
              <svg
                class="w-20 h-20 text-teal-400 mx-auto"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"
                />
              </svg>
            </div>
            <h3 class="text-2xl font-bold text-gray-50 mb-2">Connected to Advanced Host</h3>
            <p class="text-neutral-400 mb-4">WebRTC connection establishing automatically...</p>
            <div class="inline-flex items-center gap-2 bg-teal-900/30 border border-teal-700/50 rounded-lg px-4 py-2">
              <div class="w-2 h-2 bg-teal-400 rounded-full animate-pulse"></div>
              <span class="text-teal-300 text-sm font-medium">Standby Mode</span>
            </div>
          </div>

          <!-- Information -->
          <div class="bg-blue-900/20 border border-blue-700/50 rounded-lg p-6">
            <h4 class="text-blue-300 font-semibold mb-2">ℹ️ What happens next?</h4>
            <ul class="text-neutral-400 text-sm space-y-2">
              <li>• Host is establishing advanced WebRTC connections with all devices</li>
              <li>• Trickle ICE will optimize connection speed</li>
              <li>• Message queuing ensures reliable communication</li>
              <li>• Once setup is complete, host will select a game mode</li>
              <li>• Your device will automatically join the selected mode</li>
            </ul>
          </div>

          <!-- Back Button -->
          <button
            (click)="back()"
            class="w-full bg-gray-700 hover:bg-gray-600 text-white font-semibold py-3 px-6 rounded-lg transition-all"
          >
            Back to Menu
          </button>
        </div>
      }
    }
  </div>
</div>
