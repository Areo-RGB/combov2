<div class="min-h-screen bg-gray-800 text-gray-100 flex flex-col p-4">
  <header class="text-center mb-8">
  </header>

  <main class="w-full max-w-4xl mx-auto">
    @switch (mode()) {
      @case ('selection') {
        <!-- Sprint Duels Card -->
        <div class="bg-gray-800 rounded-lg shadow-2xl animate-fade-in mb-8 border border-white border-opacity-20">
          <div class="flex flex-col items-center justify-center p-6">
            <h2 class="text-2xl font-semibold mb-4 text-cyan-400">Sprint Duels</h2>
            <p class="text-gray-300 text-center mb-6">Manage, track, and rank players in head-to-head sprint competitions.</p>
            <button (click)="mode.set('sprint-duels')" class="w-full max-w-md bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-cyan-300">
              Launch Sprint Duels
            </button>
          </div>
        </div>

        <!-- Games Card -->
        <div class="bg-gray-800 rounded-lg shadow-2xl animate-fade-in mb-8 border border-white border-opacity-20">
          <div class="flex flex-col items-center justify-center p-6">
            <h2 class="text-2xl font-semibold mb-4 text-purple-400">Games</h2>
            <p class="text-gray-300 text-center mb-6">Use camera motion to interact with various display modes.</p>
            <button (click)="mode.set('motion-games')" class="w-full max-w-md bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-purple-300">
              Launch Games
            </button>
          </div>
        </div>
        
        <!-- Team Duels Card -->
        <div class="bg-gray-800 rounded-lg shadow-2xl animate-fade-in mb-8 border border-white border-opacity-20">
          <div class="flex flex-col items-center justify-center p-6">
            <h2 class="text-2xl font-semibold mb-4 text-green-400">Team Duels</h2>
            <p class="text-gray-300 text-center mb-6">A motion-based timer game to test your reaction and speed.</p>
            <button (click)="mode.set('team-duels')" class="w-full max-w-md bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-green-300">
              Launch Team Duels
            </button>
          </div>
        </div>

        <!-- Sprint Timing Card -->
        <div class="bg-gray-800 rounded-lg shadow-2xl animate-fade-in mb-8 border border-white border-opacity-20">
          <div class="flex flex-col items-center justify-center p-6">
            <h2 class="text-2xl font-semibold mb-4 text-orange-400">Sprint Timing</h2>
            <p class="text-gray-300 text-center mb-6">Time sprints with single or multiple devices using motion detection.</p>
            <button (click)="mode.set('sprint-timing-menu')" class="w-full max-w-md bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-orange-300">
              Launch Sprint Timing
            </button>
          </div>
        </div>

        <!-- Bodypose Motion Analyzer Card -->
        <div class="bg-gray-800 rounded-lg shadow-2xl animate-fade-in border border-white border-opacity-20">
          <div class="flex flex-col items-center justify-center p-6">
            <h2 class="text-2xl font-semibold mb-4 text-pink-400">Bodypose Motion Analyzer</h2>
            <p class="text-gray-300 text-center mb-6">Real-time body pose tracking and motion analysis with AI-powered joint detection.</p>
            <button (click)="mode.set('bodypose')" class="w-full max-w-md bg-pink-500 hover:bg-pink-600 text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-pink-300">
              Launch Bodypose Analyzer
            </button>
          </div>
        </div>
      }
      @case ('motion-games') {
        <div class="bg-gray-800 rounded-lg shadow-2xl p-4 sm:p-8 flex flex-col animate-fade-in w-full max-w-4xl mx-auto border border-white border-opacity-20">
          <!-- Header -->
          <app-header 
            [title]="'Games'"
            (goBack)="goBackToSelection()">
          </app-header>
          
          <!-- Content from old collapsible -->
          <div class="w-full flex flex-col items-center">
            <div class="grid md:grid-cols-2 gap-8">
              <!-- Detector Card -->
              <div class="flex flex-col items-center justify-center p-6 border border-gray-700 rounded-lg">
                <h2 class="text-2xl font-semibold mb-4 text-cyan-400">Create a Session</h2>
                <p class="text-gray-300 text-center mb-6">Use this device's camera to detect motion and send signals.</p>
                <button (click)="startDetector()" class="w-full bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-cyan-300">
                  Start Detecting
                </button>
              </div>
      
              <!-- Display Card -->
              <div class="flex flex-col items-center justify-center p-6 border border-gray-700 rounded-lg">
                <h2 class="text-2xl font-semibold mb-4 text-purple-400">Join a Session</h2>
                <p class="text-gray-300 text-center mb-6">Enter a session ID to receive motion signals and display them visually.</p>
                <div class="w-full flex flex-col items-center">
                  <input 
                    type="text" 
                    [value]="inputSessionId()"
                    (input)="handleSessionIdInput($event)"
                    placeholder="Enter 6-digit Session ID"
                    maxlength="6"
                    class="w-full text-center bg-gray-700 border border-gray-600 rounded-lg py-3 px-4 mb-4 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500 uppercase tracking-widest"
                  >
                  @if (errorMessage()) {
                    <p class="text-red-400 text-sm mb-4">{{ errorMessage() }}</p>
                  }
                  <button (click)="joinDisplay()" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-purple-300">
                    Join & Display
                  </button>
                </div>
              </div>
            </div>
            
            <!-- Single Device Mode Card -->
            <div class="mt-8 pt-8 border-t border-gray-700 flex flex-col items-center justify-center p-6 rounded-lg">
                <h2 class="text-2xl font-semibold mb-4 text-yellow-400">Single Device Mode</h2>
                <p class="text-gray-300 text-center mb-6">Use this single device to both detect motion and display the signals simultaneously.</p>
                <button (click)="startSingleDeviceMode()" class="w-full max-w-md bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-yellow-300">
                  Start Single Device Mode
                </button>
            </div>
          </div>
        </div>
      }
      @case ('detector') {
        <app-detector [sessionId]="sessionId()" (goBack)="goBackToSelection()" (motionDetected)="handleMotion($event)"></app-detector>
      }
      @case ('display') {
        <div class="bg-gray-800 rounded-lg shadow-2xl p-8 flex flex-col items-center animate-fade-in w-full max-w-3xl mx-auto border border-white border-opacity-20">
          <div class="w-full flex justify-between items-center mb-6">
            <button (click)="goBackToSelection()" title="Back to App Selection" class="bg-gray-700 hover:bg-gray-600 text-white p-3 rounded-full transition">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
              </svg>
            </button>
            <div class="text-center">
              <h2 class="text-2xl font-semibold text-purple-400">Display Mode</h2>
              <p class="text-lg font-mono bg-gray-900 px-3 py-1 rounded-md text-purple-300">Session ID: {{ sessionId() }}</p>
            </div>
            <div class="w-12 h-12"></div> <!-- Spacer to balance the button -->
          </div>
      
          <!-- Display Area -->
          <div #displayContainer class="w-full aspect-video bg-black rounded-lg overflow-hidden relative border-2 border-gray-700 mb-6" (dblclick)="toggleFullscreen()">
            <!-- Fullscreen button -->
            <button 
              (click)="toggleFullscreen()" 
              title="Toggle Fullscreen"
              class="absolute top-3 right-3 z-20 bg-gray-900 bg-opacity-40 hover:bg-opacity-60 text-white p-2 rounded-full">
              <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M8 2H4a2 2 0 0 0-2 2v4m20 0V4a2 2 0 0 0-2-2h-4m0 20h4a2 2 0 0 0 2-2v-4M8 22H4a2 2 0 0 1-2-2v-4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
            </button>
            <app-display [signal]="motionSignal()" [lingerDuration]="lingerDuration()"></app-display>
          </div>

          <!-- Display Settings Panel -->
          <div class="w-full bg-gray-700/50 rounded-lg border border-gray-600 overflow-hidden">
            <button
              (click)="toggleDisplaySettings()"
              class="w-full flex items-center justify-between p-4 text-left hover:bg-gray-600/50 transition-colors">
              <h3 class="text-lg font-semibold text-gray-200">Display Settings</h3>
              <svg 
                class="w-5 h-5 text-gray-300 transition-transform duration-200"
                [class.rotate-180]="displaySettingsExpanded()"
                fill="none" 
                stroke="currentColor" 
                viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
              </svg>
            </button>
            @if (displaySettingsExpanded()) {
              <div class="px-4 pb-4 space-y-4">
                <!-- Display Type -->
                <div>
                  <label class="block mb-2 text-sm font-medium text-gray-300">Signal Type</label>
                  <div class="flex rounded-lg bg-gray-800 p-1 gap-1">
                    <button (click)="onDisplayContentChange('color')" [class.bg-purple-500]="displayContentType() === 'color'" [class.bg-gray-600]="displayContentType() !== 'color'" [class.text-white]="displayContentType() === 'color'" class="w-full font-semibold py-2 rounded-md transition-colors">Colors</button>
                    <button (click)="onDisplayContentChange('math')" [class.bg-purple-500]="displayContentType() === 'math'" [class.bg-gray-600]="displayContentType() !== 'math'" [class.text-white]="displayContentType() === 'math'" class="w-full font-semibold py-2 rounded-md transition-colors">Math Game</button>
                    <button (click)="onDisplayContentChange('wechsel')" [class.bg-purple-500]="displayContentType() === 'wechsel'" [class.bg-gray-600]="displayContentType() !== 'wechsel'" [class.text-white]="displayContentType() === 'wechsel'" class="w-full font-semibold py-2 rounded-md transition-colors">Wechsel</button>
                    <button (click)="onDisplayContentChange('counter')" [class.bg-purple-500]="displayContentType() === 'counter'" [class.bg-gray-600]="displayContentType() !== 'counter'" [class.text-white]="displayContentType() === 'counter'" class="w-full font-semibold py-2 rounded-md transition-colors">Counter</button>
                  </div>
                </div>
                <!-- Linger Duration -->
                <div>
                  <label for="lingerDuration" class="block mb-2 text-sm font-medium text-gray-300">Linger Duration: <span class="font-bold text-purple-300">{{ lingerDuration() / 1000 }}s</span></label>
                  <input id="lingerDuration" type="range" min="100" max="5000" step="100" [value]="lingerDuration()" (input)="onLingerDurationChange($event)" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer accent-purple-500">
                </div>
                <!-- Max Operations (for Math Game) -->
                @if (displayContentType() === 'math') {
                  <div>
                    <label for="maxOperations" class="block mb-2 text-sm font-medium text-gray-300">Number of Steps: <span class="font-bold text-purple-300">{{ maxOperations() }}</span></label>
                    <input id="maxOperations" type="range" min="1" max="20" step="1" [value]="maxOperations()" (input)="onMaxOperationsChange($event)" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer accent-purple-500">
                  </div>
                }
              </div>
            }
          </div>
        </div>
      }
      @case ('single') {
        <app-single-device [sessionId]="sessionId()" (goBack)="goBackToSelection()"></app-single-device>
      }
      @case ('sprint-timing-menu') {
        <div class="w-full max-w-4xl mx-auto border border-white border-opacity-20 rounded-lg p-4 sm:p-8">
          <!-- Header -->
          <app-header 
            [title]="'Sprint Timing'"
            (goBack)="goBackToSelection()">
          </app-header>

          <!-- Single Device Card -->
          <div class="bg-gray-800 rounded-lg shadow-2xl animate-fade-in mb-8 border border-gray-700">
            <div class="flex flex-col items-center justify-center p-6">
              <h2 class="text-2xl font-semibold mb-4 text-yellow-400">Single Device</h2>
              <p class="text-gray-300 text-center mb-6">Use one device for both start and finish.</p>
              <button (click)="startSprintTimingSingleMenu()" class="w-full max-w-md bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-yellow-300">
                Select Single Device Mode
              </button>
            </div>
          </div>

          <!-- Multi-Device Card -->
          <div class="bg-gray-800 rounded-lg shadow-2xl animate-fade-in border border-gray-700">
            <div class="flex flex-col items-center justify-center p-6">
              <h2 class="text-2xl font-semibold mb-4 text-orange-400">Multi-Device</h2>
              <p class="text-gray-300 text-center mb-6">Use multiple devices (start, split, finish)</p>
              <button (click)="startMultiDeviceSetup()" class="w-full max-w-md bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-orange-300">
                Multi Device
              </button>
            </div>
          </div>
        </div>
      }
      @case ('sprint-timing-single-menu') {
        <div class="w-full max-w-4xl mx-auto border border-white border-opacity-20 rounded-lg p-4 sm:p-8">
          <!-- Header -->
          <app-header 
            [title]="'Single Device'"
            (goBack)="mode.set('sprint-timing-menu')">
          </app-header>

          <!-- Single Device - Manual Start Card -->
          <div class="bg-gray-800 rounded-lg shadow-2xl animate-fade-in mb-8 border border-gray-700">
            <div class="flex flex-col items-center justify-center p-6">
              <h2 class="text-2xl font-semibold mb-4 text-orange-400">Manual Start</h2>
              <p class="text-gray-300 text-center mb-6">Use one device for both start and finish. Button to start.</p>
              <button (click)="startSprintTimingManual()" class="w-full max-w-md bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-orange-300">
                Launch Manual Start
              </button>
            </div>
          </div>

          <!-- Single Device - Flying Start Card -->
          <div class="bg-gray-800 rounded-lg shadow-2xl animate-fade-in border border-gray-700">
            <div class="flex flex-col items-center justify-center p-6">
              <h2 class="text-2xl font-semibold mb-4 text-orange-400">Flying Start</h2>
              <p class="text-gray-300 text-center mb-6">Use one device for both start and finish. Motion auto-starts.</p>
              <button (click)="startSprintTimingFlying()" class="w-full max-w-md bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-orange-300">
                Launch Flying Start
              </button>
            </div>
          </div>
        </div>
      }
      @case ('sprint-timing-manual') {
        <app-sprint-timing [sessionId]="sessionId()" [startMode]="'manual'" (goBack)="goBackToSelection()"></app-sprint-timing>
      }
      @case ('sprint-timing-flying') {
        <app-sprint-timing [sessionId]="sessionId()" [startMode]="'flying'" (goBack)="goBackToSelection()"></app-sprint-timing>
      }
      @case ('sprint-multi-setup') {
        <app-sprint-multi-setup
          [initialSessionId]="joinSprintSessionId()"
          (goBack)="goBackToSelection()"
          (startSession)="handleMultiDeviceStart($event)">
        </app-sprint-multi-setup>
      }
      @case ('sprint-multi-timing') {
        @if (multiDeviceConfig(); as config) {
          <app-sprint-timing-multi
            [sessionId]="config.sessionId"
            [startMode]="config.startMode"
            [deviceRole]="config.deviceRole"
            [minDetectionDelayInput]="config.minDetectionDelay"
            [selectedCameraId]="config.selectedCameraId"
            [isSingleDevice]="false"
            (goBack)="goBackToSelection()">
          </app-sprint-timing-multi>
        }
      }
      @case ('sprint-duels') {
        <app-sprint-duels (goBack)="goBackToSelection()"></app-sprint-duels>
      }
      @case ('team-duels') {
        <app-team-duels (goBack)="goBackToSelection()"></app-team-duels>
      }
      @case ('bodypose') {
        <app-bodypose (goBack)="goBackToSelection()"></app-bodypose>
      }
    }
  </main>
</div>
