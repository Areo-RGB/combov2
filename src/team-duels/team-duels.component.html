<div class="bg-gray-800 rounded-lg shadow-2xl p-4 sm:p-8 flex flex-col items-center animate-fade-in w-full max-w-7xl mx-auto">
  @switch (mode()) {
    @case ('selection') {
      <!-- Header -->
      <div class="w-full flex justify-between items-center mb-6">
        <button (click)="onGoBackToMenu()" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition">
          &larr; Back
        </button>
        <h2 class="text-3xl font-bold text-white">Team Duels</h2>
        <div class="w-20"></div> <!-- Spacer for centering -->
      </div>

      <div class="grid md:grid-cols-2 gap-8 w-full max-w-4xl">
        <!-- Single Device Card -->
        <div class="flex flex-col items-center justify-center p-6 border border-gray-700 rounded-lg">
          <h2 class="text-2xl font-semibold mb-4 text-green-400">Single Device</h2>
          <p class="text-gray-300 text-center mb-6">Play offline on one device using the camera for start/stop signals.</p>
          <button (click)="startSingleDeviceMode()" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-green-300">
            Start Offline Game
          </button>
        </div>

        <!-- Multi Device Card -->
        <div class="flex flex-col items-center justify-center p-6 border border-gray-700 rounded-lg">
          <h2 class="text-2xl font-semibold mb-4 text-cyan-400">Multi Device</h2>
          <p class="text-gray-300 text-center mb-6">Connect multiple devices to compete online.</p>
          <button (click)="startMultiDeviceMode()" class="w-full bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105 focus:outline-none focus:ring-4 focus:ring-cyan-300">
            Start Online Game
          </button>
        </div>
      </div>
    }
    @case ('lobby') {
      <app-team-duels-lobby (goBack)="goBackToSelection()" (sessionStarted)="onSessionStarted($event)"></app-team-duels-lobby>
    }
    @case ('display-host') {
      @if (sessionId(); as sid) {
        <app-display-host [sessionId]="sid"></app-display-host>
      }
    }
    @case ('game-client') {
      <div class="w-full">
        <div class="w-full flex justify-between items-center mb-6">
          <button (click)="goBackToSelection()" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition">
            &larr; Leave Game
          </button>
          <h2 class="text-2xl font-semibold text-cyan-400">Game Client</h2>
          <div class="text-sm font-mono bg-gray-900 px-2 py-1 rounded-md text-cyan-300">Player ID: {{ deviceId().substring(0,6) }}</div>
        </div>
        @if (sessionId(); as sid) {
          <app-game-client [sessionId]="sid" [deviceId]="deviceId()"></app-game-client>
        }
      </div>
    }
    @case ('single-device') {
      <!-- Game Header -->
      <div class="w-full flex justify-between items-center mb-6">
        <button (click)="goBackToSelection()" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition">
          &larr; Back to Modes
        </button>
        <h2 class="text-2xl font-semibold text-green-400">Single Device Mode</h2>
         <button (click)="resetGame()" class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-2 px-4 rounded-lg transition">
          Reset Game
        </button>
      </div>

      <!-- Main Game Grid -->
      <div class="w-full grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Left Column: Detector -->
        <div class="min-w-0">
          <app-detector [sessionId]="'team-duel-offline'" [showBackButton]="false" (motionDetected)="handleMotion()"></app-detector>
        </div>

        <!-- Right Column: Game State & Settings -->
        <div class="flex flex-col gap-6">
          <!-- Livepool Display -->
          <div class="bg-gray-900/50 p-6 rounded-lg text-center border border-gray-700">
            <h3 class="text-lg font-semibold text-gray-400 uppercase tracking-wider">Live Pool</h3>
            <div class="my-4 text-7xl font-black text-green-400" [class.text-red-500]="livepool() < 0">
              {{ livepool().toFixed(2) }}
            </div>
            <div class="w-full bg-gray-700 rounded-full h-4 border border-gray-600">
               <div class="bg-gradient-to-r from-green-500 to-teal-400 h-full rounded-full transition-all duration-500" [style.width.%]="getLivepoolPercentage()"></div>
            </div>
          </div>
          
          <!-- Timer Display -->
          <div class="bg-gray-900/50 p-6 rounded-lg text-center border border-gray-700">
            <h3 class="text-lg font-semibold text-gray-400 uppercase tracking-wider">
              @if (timerStartTime() === null) {
                Last Reaction Time
              } @else {
                Current Time
              }
            </h3>
            <div class="my-4 text-7xl font-black" [class.text-yellow-400]="timerStartTime() !== null" [class.text-white]="timerStartTime() === null">
              {{ elapsedTime() }}
            </div>
            @if (timerStartTime() === null) {
              <p class="text-gray-500 h-6">Waiting for first motion...</p>
            } @else {
              <p class="text-yellow-400 h-6 animate-pulse">Timer running... waiting for second motion.</p>
            }
          </div>
          
          <!-- Settings Panel -->
           <div class="w-full bg-gray-700/50 p-4 rounded-lg border border-gray-600">
            <h3 class="text-lg font-semibold mb-4 text-gray-200 border-b border-gray-600 pb-2">Game Settings</h3>
             <div>
                <label for="livepool-start" class="block mb-2 text-sm font-medium text-gray-300">Initial Live Pool: <span class="font-bold text-green-300">{{ initialLivepool() }}</span></label>
                <input id="livepool-start" type="range" min="10" max="300" step="10" [value]="initialLivepool()" (input)="onInitialLivepoolChange($event)" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer accent-green-500">
              </div>
              <div class="mt-4">
                <label for="voice-select" class="block mb-2 text-sm font-medium text-gray-300">Announcement Voice</label>
                <select id="voice-select" 
                        class="w-full bg-gray-600 border border-gray-500 text-white text-sm rounded-lg focus:ring-green-500 focus:border-green-500 block p-2.5"
                        [value]="selectedVoiceURI()"
                        (change)="onVoiceChange($event)">
                    <optgroup label="Custom Audio">
                        @for (voice of preRecordedVoiceOptions; track voice.key) {
                            <option [value]="voice.key">{{ voice.name }}</option>
                        }
                    </optgroup>
                    @if (availableVoices().length > 0) {
                        <optgroup label="Browser Voices (German)">
                            @for (voice of availableVoices(); track voice.voiceURI) {
                                <option [value]="voice.voiceURI">{{ voice.name }} ({{ voice.lang }})</option>
                            }
                        </optgroup>
                    }
                </select>
              </div>
          </div>

          <!-- Action Buttons / Status -->
          <div class="w-full flex flex-col items-center">
              <div class="w-full max-w-md flex gap-4">
                  <!-- Game Control Button -->
                  @switch (gameState()) {
                      @case ('running') {
                          <button (click)="pauseGame()" class="w-2/3 bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-bold py-3 px-6 rounded-lg text-lg transition-transform transform hover:scale-105">
                              Pause Game
                          </button>
                      }
                      @case ('paused') {
                          <button (click)="resumeGame()" class="w-2/3 bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg text-lg transition-transform transform hover:scale-105">
                              Resume Game
                          </button>
                      }
                      @default {
                          <button (click)="startGame()" class="w-2/3 bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-lg text-lg transition-transform transform hover:scale-105">
                              Start Game
                          </button>
                      }
                  }
              
                  <!-- Detection Control Button -->
                  @if (detector()?.status() !== 'detecting') {
                      <button (click)="detector()?.startDetection()" class="w-1/3 bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg text-lg transition-transform transform hover:scale-105">
                          Start
                      </button>
                  } @else {
                      <button (click)="stopDetectionAndGame()" class="w-1/3 bg-red-500 hover:bg-red-600 text-white font-bold py-3 px-6 rounded-lg text-lg transition-transform transform hover:scale-105">
                          Stop
                      </button>
                  }
              </div>

              <!-- Status Text -->
              @if (detector()?.status() === 'detecting') {
                  <div class="text-center h-16 mt-4">
                      <p class="text-lg text-green-400 flex items-center justify-center">
                          <span class="relative flex h-3 w-3 mr-3">
                              <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                              <span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
                          </span>
                          Actively detecting motion...
                      </p>
                      @if (detector()?.lastMotionSignal(); as signalText) {
                          <p class="text-yellow-400 mt-2 animate-pulse">{{ signalText }}</p>
                      }
                  </div>
              }
          </div>
        </div>
      </div>
    }
  }
</div>
