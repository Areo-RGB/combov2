<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 animate-fade-in">
  <!-- Left Column: Player Selection & Pairing -->
  <div class="lg:col-span-1 bg-gray-800 rounded-lg shadow-lg p-6 flex flex-col gap-6 h-fit lg:block border border-white border-opacity-20" [class.hidden]="isArenaViewActive()">
    
    @if (isTournamentActive()) {
       <div class="text-center p-4 bg-orange-900/50 border border-orange-700 rounded-lg">
           <h3 class="text-xl font-bold text-orange-300">Tournament Active</h3>
           <p class="text-orange-400 text-sm">Complete tournament matches to proceed.</p>
           <button (click)="cancelTournament()" class="mt-4 bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-4 rounded-lg text-sm">
             Cancel Tournament
           </button>
       </div>
    } @else {
      <!-- Player Selection -->
      <div>
        <h3 class="text-xl font-bold text-cyan-400 mb-4">Select Players</h3>
        <div class="max-h-60 overflow-y-auto pr-2 space-y-2">
          @for (player of playerService.players(); track player.id) {
            <label class="flex items-center justify-between bg-gray-700/60 p-2 rounded-md cursor-pointer hover:bg-gray-700">
              <span class="text-white">{{ player.name }} ({{player.jerseyNumber}})</span>
              <input 
                type="checkbox" 
                class="w-5 h-5 rounded text-cyan-500 bg-gray-600 border-gray-500 focus:ring-cyan-600 focus:ring-2"
                [checked]="player.isParticipating"
                (change)="toggleParticipation(player, $event)"
                [disabled]="isRoundInProgress()">
            </label>
          }
        </div>
      </div>
      <!-- Pairing Generation -->
      <div class="border-t border-gray-700 pt-6">
        <h3 class="text-xl font-bold text-cyan-400 mb-4">Generate Duels</h3>
        <div class="flex flex-col gap-3">
          <button 
            (click)="generateRandomPairings()" 
            [disabled]="isRoundInProgress()"
            class="w-full bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-2 px-4 rounded-lg disabled:bg-gray-600 disabled:cursor-not-allowed">
            Random Pairings
          </button>
          <button 
            (click)="generateEloBasedPairings()" 
            [disabled]="isRoundInProgress()"
            class="w-full bg-orange-600 hover:bg-orange-500 text-white font-bold py-2 px-4 rounded-lg disabled:bg-gray-600 disabled:cursor-not-allowed">
            Elo-Based Pairings
          </button>
        </div>
      </div>

       <!-- Tournament Mode -->
      <div class="border-t border-gray-700 pt-6">
        <h3 class="text-xl font-bold text-purple-400 mb-4">Tournament Mode</h3>
        <div class="flex flex-col gap-3">
          <button 
            (click)="startTournament()" 
            [disabled]="isRoundInProgress() || participatingPlayers().length < 3"
            class="w-full bg-purple-600 hover:bg-purple-500 text-white font-bold py-2 px-4 rounded-lg disabled:bg-gray-600 disabled:cursor-not-allowed">
            Start Tournament
          </button>
        </div>
      </div>
    }
  </div>

  <!-- Right Column: Duel Arena -->
  <div class="lg:col-span-2">
    @if (duels().length > 0) {
      <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
        @for (duel of duels(); track duel.player1.id + duel.player2.id) {
          <div class="bg-gray-800 rounded-lg shadow-lg p-5 flex flex-col gap-4 border border-white border-opacity-20">
            <!-- Players -->
            <div class="flex justify-around items-center text-center">
              <!-- Player 1 -->
              <div class="flex-1 flex flex-col items-center">
                <div (click)="speakName(duel.player1.name)" class="w-16 h-16 rounded-full bg-gray-700 flex items-center justify-center text-2xl font-black mb-2 border-2 border-cyan-500 cursor-pointer hover:bg-gray-600 transition-colors">{{ duel.player1.jerseyNumber }}</div>
                <h4 class="text-lg font-bold text-white">{{ duel.player1.name }}</h4>
                <p class="text-sm text-gray-400 font-mono">Elo: {{ duel.player1.elo }}</p>
                <p class="text-xs text-cyan-400">Win Prob: {{ (eloService.calculateWinProbability(duel.player1.elo, duel.player2.elo) * 100).toFixed(0) }}%</p>
              </div>
              
              <!-- VS & Beep Button -->
              <div class="flex flex-col items-center gap-1 px-2">
                <span class="text-3xl font-black text-gray-500">VS</span>
                <button (click)="$event.stopPropagation(); audioService.playBeep()" title="Play Beep" class="bg-gray-600 hover:bg-gray-500 text-white p-1.5 rounded-full transition-colors leading-none">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                  </svg>
                </button>
              </div>

              <!-- Player 2 -->
              <div class="flex-1 flex flex-col items-center">
                <div (click)="speakName(duel.player2.name)" class="w-16 h-16 rounded-full bg-gray-700 flex items-center justify-center text-2xl font-black mb-2 border-2 border-orange-500 cursor-pointer hover:bg-gray-600 transition-colors">{{ duel.player2.jerseyNumber }}</div>
                <h4 class="text-lg font-bold text-white">{{ duel.player2.name }}</h4>
                <p class="text-sm text-gray-400 font-mono">Elo: {{ duel.player2.elo }}</p>
                <p class="text-xs text-orange-400">Win Prob: {{ (eloService.calculateWinProbability(duel.player2.elo, duel.player1.elo) * 100).toFixed(0) }}%</p>
              </div>
            </div>

            <!-- Start Race Button -->
             <button (click)="audioService.playStartRaceCue(duel.player1, duel.player2)" class="w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" /></svg>
                Start Race
              </button>
              
            <!-- Result Declaration -->
            <div class="border-t border-gray-700 pt-4 flex flex-col gap-3">
              <div class="flex gap-3">
                <button (click)="declareWinner(duel, duel.player1)" class="w-full bg-cyan-600 hover:bg-cyan-500 text-white font-semibold py-2 rounded-md">Winner</button>
                <button (click)="declareWinner(duel, duel.player2)" class="w-full bg-orange-600 hover:bg-orange-500 text-white font-semibold py-2 rounded-md">Winner</button>
              </div>
              @if (!isTournamentActive()) {
                <button (click)="declareDraw(duel)" class="w-full bg-gray-500 hover:bg-gray-400 text-white font-semibold py-2 rounded-md">Declare Draw</button>
              }
            </div>
          </div>
        }
      </div>
    } @else {
      <div class="text-center bg-gray-800 rounded-lg p-10 flex flex-col items-center justify-center h-full border border-white border-opacity-20">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-gray-600 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
        </svg>
        <h3 class="text-2xl font-bold text-gray-400">Duel Arena</h3>
        <p class="text-gray-500">Select players and generate pairings to start a new round.</p>
        @if (tournamentService.tournament()?.status === 'finished') {
           <div class="mt-6 p-4 bg-orange-900/50 border border-orange-700 rounded-lg">
             <h3 class="text-xl font-bold text-orange-300">Tournament Finished!</h3>
             <p class="text-orange-400 text-lg">Winner: {{ tournamentService.tournament()?.winner?.name }}</p>
              <button (click)="cancelTournament()" class="mt-4 bg-cyan-600 hover:bg-cyan-500 text-white font-bold py-2 px-4 rounded-lg text-sm">
               Start New Round
             </button>
           </div>
        }
      </div>
    }
  </div>
</div>

@if (isRoundInProgress()) {
  <button 
    (click)="isArenaViewActive.set(!isArenaViewActive())"
    [title]="isArenaViewActive() ? 'Show Controls' : 'Arena View'"
    class="lg:hidden fixed bottom-24 right-5 z-20 bg-cyan-600 hover:bg-cyan-500 text-white font-bold p-3 rounded-full shadow-lg flex items-center justify-center transition-transform hover:scale-110">
    @if (isArenaViewActive()) {
      <!-- Settings Icon for "Show Controls" -->
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
        <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
      </svg>
    } @else {
      <!-- Expand Icon for "Arena View" -->
      <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 5v-4m0 0h-4m4 0l-5-5" />
      </svg>
    }
  </button>
}